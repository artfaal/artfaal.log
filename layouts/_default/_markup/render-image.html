{{- /*
  Hugo Markdown render hook for images (responsive + lazy-load).

  - Local Page Resources only are processed
  - WebP format with high quality (q95)
  - Source images are pre-optimized by optimize_post_images.py
  - Render hook only creates responsive sizes (no quality compression)
  - Longest side capped at 1600px
  - Responsive srcset for mobile/retina
  - Native lazy-loading via loading="lazy"
  - Optimized for PaperMod theme
*/ -}}

{{- $dest  := .Destination -}}
{{- $alt   := .Text | default "" -}}
{{- $title := .Title | default "" -}}

{{- /* Remote images: render as-is (Hugo can't process them) */ -}}
{{- if or (hasPrefix $dest "http://") (hasPrefix $dest "https://") -}}
  <figure>
    <img
      src="{{ $dest | safeURL }}"
      alt="{{ $alt | htmlEscape }}"
      loading="lazy"
      decoding="async"
    >
    {{- if $title -}}<figcaption>{{ $title | htmlEscape }}</figcaption>{{- end -}}
  </figure>
{{- else -}}

  {{- $img := .Page.Resources.GetMatch $dest -}}

  {{- if not $img -}}
    {{- /* Not a Page Resource: render as-is */ -}}
    <figure>
      <img
        src="{{ $dest | safeURL }}"
        alt="{{ $alt | htmlEscape }}"
        loading="lazy"
        decoding="async"
      >
      {{- if $title -}}<figcaption>{{ $title | htmlEscape }}</figcaption>{{- end -}}
    </figure>
  {{- else -}}

    {{- /* Settings */ -}}
    {{- $q := "webp q95" -}}
    {{- $maxWidth := 1600 -}}

    {{- /* Generate a set of responsive widths (preserving aspect ratio) */ -}}
    {{- $wList := slice 360 540 720 960 1200 1600 -}}

    {{- /* The "main" image (max size) is used for width/height to prevent CLS */ -}}
    {{- /* Resize only by width to preserve aspect ratio */ -}}
    {{- $main := ($img.Resize (printf "%dx" $maxWidth)).Process $q -}}

    {{- /* Build srcset */ -}}
    {{- $srcset := slice -}}
    {{- range $wList -}}
      {{- /* Resize by width only - this preserves aspect ratio! */ -}}
      {{- $candidate := ($img.Resize (printf "%dx" .)).Process $q -}}
      {{- $srcset = $srcset | append (printf "%s %dw" $candidate.RelPermalink $candidate.Width) -}}
    {{- end -}}

    {{- /* sizes: Custom width 900px (1000px on large screens) */ -}}
    {{- $sizes := "(max-width: 768px) 100vw, (max-width: 1400px) 900px, 1000px" -}}

    <figure>
      <img
        src="{{ $main.RelPermalink }}"
        srcset="{{ delimit $srcset ", " }}"
        sizes="{{ $sizes }}"
        width="{{ $main.Width }}"
        height="{{ $main.Height }}"
        alt="{{ $alt | htmlEscape }}"
        loading="lazy"
        decoding="async"
      >
      {{- if $title -}}<figcaption>{{ $title | htmlEscape }}</figcaption>{{- end -}}
    </figure>

  {{- end -}}
{{- end -}}
