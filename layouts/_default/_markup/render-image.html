{{- /*
  Hugo Markdown render hook for images (responsive + lazy-load).

  - Local Page Resources only are processed
  - WebP only (no fallback formats)
  - Quality: 80
  - Longest side capped at 1200px (via Fit 1200x1200)
  - Responsive srcset for mobile/retina
  - Native lazy-loading via loading="lazy"
  - Optimized for PaperMod theme
*/ -}}

{{- $dest  := .Destination -}}
{{- $alt   := .Text | default "" -}}
{{- $title := .Title | default "" -}}

{{- /* Remote images: render as-is (Hugo can't process them) */ -}}
{{- if or (hasPrefix $dest "http://") (hasPrefix $dest "https://") -}}
  <figure>
    <img
      src="{{ $dest | safeURL }}"
      alt="{{ $alt | htmlEscape }}"
      loading="lazy"
      decoding="async"
    >
    {{- if $title -}}<figcaption>{{ $title | htmlEscape }}</figcaption>{{- end -}}
  </figure>
{{- else -}}

  {{- $img := .Page.Resources.GetMatch $dest -}}

  {{- if not $img -}}
    {{- /* Not a Page Resource: render as-is */ -}}
    <figure>
      <img
        src="{{ $dest | safeURL }}"
        alt="{{ $alt | htmlEscape }}"
        loading="lazy"
        decoding="async"
      >
      {{- if $title -}}<figcaption>{{ $title | htmlEscape }}</figcaption>{{- end -}}
    </figure>
  {{- else -}}

    {{- /* Settings */ -}}
    {{- $q := "webp q80" -}}
    {{- $max := "1200x1200" -}}

    {{- /* Generate a set of responsive widths (all capped by Fit to preserve aspect) */ -}}
    {{- $wList := slice 360 540 720 960 1200 -}}

    {{- /* The "main" image (max size) is used for width/height to prevent CLS */ -}}
    {{- $main := ($img.Fit $max).Process $q -}}

    {{- /* Build srcset */ -}}
    {{- $srcset := slice -}}
    {{- range $wList -}}
      {{- $candidate := ($img.Fit (printf "%dx%d" . .)).Process $q -}}
      {{- $srcset = $srcset | append (printf "%s %dw" $candidate.RelPermalink $candidate.Width) -}}
    {{- end -}}

    {{- /* sizes: PaperMod content column is ~720px on desktop */ -}}
    {{- $sizes := "(max-width: 768px) 100vw, 720px" -}}

    <figure>
      <img
        src="{{ $main.RelPermalink }}"
        srcset="{{ delimit $srcset ", " }}"
        sizes="{{ $sizes }}"
        width="{{ $main.Width }}"
        height="{{ $main.Height }}"
        alt="{{ $alt | htmlEscape }}"
        loading="lazy"
        decoding="async"
      >
      {{- if $title -}}<figcaption>{{ $title | htmlEscape }}</figcaption>{{- end -}}
    </figure>

  {{- end -}}
{{- end -}}
